<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Puanlama Yapılandırması - Optik Okuyucu</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <meta name="color-scheme" content="light">
    <script src="theme-manager.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#7C3AED",
                        background: "#FAFAFA",
                        surface: "#FFFFFF",
                        "text-main": "#1e293b",
                        "text-muted": "#64748b",
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.04)',
                        'glow': '0 4px 14px rgba(124, 58, 237, 0.15)',
                    }
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #fdfdff;
            min-height: 100vh;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .input-chip {
            flex: 1 1 0%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 700;
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 200ms;
            border-width: 2px;
        }

        .chip-active {
            background-color: #7C3AED;
            color: #ffffff;
            border-color: #7C3AED;
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.15);
        }

        .chip-inactive {
            background-color: #ffffff;
            color: #94a3b8;
            border-color: #f8fafc;
        }

        .chip-inactive:hover {
            border-color: #f1f5f9;
        }
    </style>
</head>

<body class="font-sans antialiased text-text-main">
    <div class="max-w-md mx-auto min-h-screen relative flex flex-col bg-[#fdfdff] shadow-xl overflow-hidden pb-10">
        <!-- Header -->
        <header
            class="px-6 pt-10 pb-4 flex items-center justify-between sticky top-0 bg-[#fdfdff]/80 backdrop-blur-md z-30">
            <button onclick="window.history.back()"
                class="w-10 h-10 rounded-full bg-white shadow-soft flex items-center justify-center text-gray-500 hover:text-primary transition-colors border border-gray-50">
                <span class="material-symbols-outlined text-2xl">chevron_left</span>
            </button>
            <h1 class="font-extrabold text-lg text-gray-900">Puanlama Yapılandırması</h1>
            <div class="w-10"></div> <!-- Spacer -->
        </header>

        <main class="flex-1 px-6 space-y-7 overflow-y-auto no-scrollbar pt-2">
            <!-- Sınav Seçin Section -->
            <div class="space-y-3">
                <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">SINAV SEÇİN</h3>
                <div class="relative group">
                    <div
                        class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary transition-colors">
                        <span class="material-symbols-outlined text-[22px]">search</span>
                    </div>
                    <select id="examSelect" onchange="loadScoringConfig()"
                        class="w-full appearance-none bg-white bg-none border border-gray-100 rounded-3xl pl-12 pr-12 py-5 text-sm font-bold text-gray-600 focus:ring-4 focus:ring-primary/5 focus:border-primary/20 transition-all cursor-pointer shadow-card">
                        <option value="" disabled selected>Bir sınav seçiniz...</option>
                    </select>
                    <span
                        class="material-symbols-outlined absolute right-5 top-1/2 -translate-y-1/2 text-gray-300 pointer-events-none">unfold_more</span>
                </div>
            </div>

            <!-- Puanlama İşlemleri Section -->
            <div class="space-y-3">
                <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">PUANLAMA İŞLEMLERİ</h3>
                <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-card flex gap-4">
                    <div class="flex-1 space-y-2 text-center">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">Minimum
                            Puan</label>
                        <input type="number" id="minScore" value="0"
                            class="w-full bg-gray-50/50 border-none rounded-2xl py-4 text-center text-lg font-black text-gray-900 focus:ring-2 focus:ring-primary/10 transition-all" />
                    </div>
                    <div class="flex-1 space-y-2 text-center">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">Maksimum
                            Puan</label>
                        <input type="number" id="maxScore" value="100"
                            class="w-full bg-gray-50/50 border-none rounded-2xl py-4 text-center text-lg font-black text-gray-900 focus:ring-2 focus:ring-primary/10 transition-all" />
                    </div>
                </div>
            </div>

            <!-- Net Hesaplama Section -->
            <div class="space-y-3">
                <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">NET HESAPLAMA</h3>
                <div class="bg-white p-2 rounded-3xl border border-gray-100 shadow-card flex gap-1"
                    id="netOptionsContainer">
                    <button type="button" onclick="selectNetOption(this)" data-value="3y1d"
                        class="flex-1 py-4 px-2 rounded-2xl text-center text-[11px] font-black transition-all duration-200 bg-primary text-white shadow-glow">
                        3 Yanlış 1 Doğru
                    </button>
                    <button type="button" onclick="selectNetOption(this)" data-value="4y1d"
                        class="flex-1 py-4 px-2 rounded-2xl text-center text-[11px] font-black transition-all duration-200 text-gray-400 hover:text-gray-600">
                        4 Yanlış 1 Doğru
                    </button>
                    <button type="button" onclick="selectNetOption(this)" data-value="yd"
                        class="flex-1 py-4 px-2 rounded-2xl text-center text-[11px] font-black transition-all duration-200 text-gray-400 hover:text-gray-600">
                        - Yanlış - Doğru
                    </button>
                </div>
            </div>

            <script type="module">
                import { getExams, getExamById, saveExam, getCurrentUser } from './firebase-config.js?v=3.2';

                let selectedNetOption = "3y1d";

                window.selectNetOption = function (button) {
                    const container = document.getElementById('netOptionsContainer');
                    const buttons = container.querySelectorAll('button');

                    buttons.forEach(btn => {
                        btn.className = "flex-1 py-4 px-2 rounded-2xl text-center text-[11px] font-black transition-all duration-200 text-gray-400 hover:text-gray-600";
                    });

                    button.className = "flex-1 py-4 px-2 rounded-2xl text-center text-[11px] font-black transition-all duration-200 bg-primary text-white shadow-glow";
                    selectedNetOption = button.getAttribute('data-value');
                }

                async function loadExams() {
                    const select = document.getElementById('examSelect');
                    const sessionUser = getCurrentUser();
                    const filterId = (sessionUser && sessionUser.role !== 'admin') ? sessionUser.id : null;

                    try {
                        const exams = await getExams(filterId);

                        // Clear existing except placeholder
                        select.innerHTML = '<option value="" disabled selected>Bir sınav seçiniz...</option>';

                        exams.forEach((exam) => {
                            const option = document.createElement('option');
                            option.value = exam.id;
                            option.textContent = `${exam.name} (${exam.type})`;
                            select.appendChild(option);
                        });
                    } catch (e) {
                        console.error("Error loading exams:", e);
                    }
                }

                window.loadScoringConfig = async function () {
                    const examId = document.getElementById('examSelect').value;
                    if (!examId) return;

                    try {
                        const exam = await getExamById(examId);
                        if (exam && exam.scoring) {
                            const config = exam.scoring;
                            document.getElementById('minScore').value = config.minScore || 0;
                            document.getElementById('maxScore').value = config.maxScore || 100;

                            // Set net option
                            const buttons = document.querySelectorAll('#netOptionsContainer button');
                            buttons.forEach(btn => {
                                if (btn.getAttribute('data-value') === config.netOption) {
                                    selectNetOption(btn);
                                }
                            });

                            // Set coefficients
                            if (config.weights) {
                                document.getElementById('weight_turkce').value = config.weights.turkce || "4.0";
                                document.getElementById('weight_matematik').value = config.weights.matematik || "4.0";
                                document.getElementById('weight_fen').value = config.weights.fen || "3.0";
                                document.getElementById('weight_sosyal').value = config.weights.sosyal || "2.0";
                            }
                        } else {
                            // Reset to defaults if no config exists
                            document.getElementById('minScore').value = 0;
                            document.getElementById('maxScore').value = 100;
                            document.getElementById('weight_turkce').value = "4.0";
                            document.getElementById('weight_matematik').value = "4.0";
                            document.getElementById('weight_fen').value = "3.0";
                            document.getElementById('weight_sosyal').value = "2.0";
                        }
                    } catch (e) {
                        console.error("Error loading scoring config:", e);
                    }
                }

                window.saveScoringConfig = async function () {
                    const examId = document.getElementById('examSelect').value;
                    if (!examId) {
                        alert('Lütfen önce bir sınav seçiniz.');
                        return;
                    }

                    const btn = document.querySelector('button[onclick="saveScoringConfig()"]');
                    const originalHTML = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Kaydediliyor...';

                    try {
                        const exam = await getExamById(examId);
                        if (!exam) throw new Error("Sınav bulunamadı.");

                        const scoringConfig = {
                            minScore: parseFloat(document.getElementById('minScore').value) || 0,
                            maxScore: parseFloat(document.getElementById('maxScore').value) || 100,
                            netOption: selectedNetOption,
                            weights: {
                                turkce: parseFloat(document.getElementById('weight_turkce').value) || 0,
                                matematik: parseFloat(document.getElementById('weight_matematik').value) || 0,
                                fen: parseFloat(document.getElementById('weight_fen').value) || 0,
                                sosyal: parseFloat(document.getElementById('weight_sosyal').value) || 0
                            },
                            updatedAt: new Date().toISOString()
                        };

                        // Merge with existing exam data
                        const updatedExam = {
                            ...exam,
                            scoring: scoringConfig
                        };

                        await saveExam(updatedExam);
                        alert('Puanlama yapılandırması başarıyla kaydedildi.');
                        window.history.back();
                    } catch (e) {
                        console.error("Error saving scoring config:", e);
                        alert('Kaydedilirken bir hata oluştu.');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalHTML;
                    }
                }

                window.onload = loadExams;
            </script>

            <!-- Ders Katsayıları Section -->
            <div class="space-y-3">
                <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] ml-1">DERS KATSAYILARI
                    (AĞIRLIK)</h3>
                <div class="bg-white rounded-3xl border border-gray-100 shadow-card divide-y divide-gray-50">
                    <!-- Türkçe -->
                    <div class="px-5 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined filled">menu_book</span>
                            </div>
                            <span class="text-sm font-bold text-gray-700">Türkçe</span>
                        </div>
                        <input type="text" id="weight_turkce" value="4.0"
                            class="w-16 bg-gray-50/50 border-none rounded-xl py-2 text-center text-sm font-black text-primary focus:ring-2 focus:ring-primary/10" />
                    </div>
                    <!-- Matematik -->
                    <div class="px-5 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined filled">calculate</span>
                            </div>
                            <span class="text-sm font-bold text-gray-700">Matematik</span>
                        </div>
                        <input type="text" id="weight_matematik" value="4.0"
                            class="w-16 bg-gray-50/50 border-none rounded-xl py-2 text-center text-sm font-black text-primary focus:ring-2 focus:ring-primary/10" />
                    </div>
                    <!-- Fen -->
                    <div class="px-5 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined filled">science</span>
                            </div>
                            <span class="text-sm font-bold text-gray-700">Fen Bilimleri</span>
                        </div>
                        <input type="text" id="weight_fen" value="3.0"
                            class="w-16 bg-gray-50/50 border-none rounded-xl py-2 text-center text-sm font-black text-primary focus:ring-2 focus:ring-primary/10" />
                    </div>
                    <!-- Sosyal -->
                    <div class="px-5 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-primary">
                                <span class="material-symbols-outlined filled">public</span>
                            </div>
                            <span class="text-sm font-bold text-gray-700">Sosyal Bilgiler</span>
                        </div>
                        <input type="text" id="weight_sosyal" value="2.0"
                            class="w-16 bg-gray-50/50 border-none rounded-xl py-2 text-center text-sm font-black text-primary focus:ring-2 focus:ring-primary/10" />
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <button onclick="saveScoringConfig()"
                class="w-full bg-primary hover:bg-primary-dark text-white font-black py-5 rounded-[2rem] shadow-glow active:scale-[0.98] transition-all duration-200 text-lg flex items-center justify-center gap-3 mt-4 mb-4">
                <span class="material-symbols-outlined filled">save</span>
                Kaydet
            </button>
        </main>
    </div>
</body>

</html>