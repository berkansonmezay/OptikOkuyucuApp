<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Öğrenci Karnesi - Optik Okuyucu</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <meta name="color-scheme" content="light">
    <script src="theme-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#7C3AED",
                        background: "#FAFAFA",
                        surface: "#FFFFFF",
                        "text-main": "#1e293b",
                        "text-muted": "#64748b",
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.04)',
                    }
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #f8fafc;
            min-height: 100vh;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .radar-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
    </style>
</head>

<body class="font-sans antialiased text-text-main">
    <div class="max-w-md mx-auto min-h-screen relative flex flex-col bg-white shadow-xl overflow-hidden pb-10">
        <!-- Header -->
        <header class="px-6 pt-10 pb-6 flex items-center justify-between bg-white sticky top-0 z-20">
            <button onclick="window.history.back()" class="text-gray-900 hover:text-primary transition-colors">
                <span class="material-symbols-outlined text-2xl">chevron_left</span>
            </button>
            <h1 class="font-extrabold text-lg text-gray-900">Öğrenci Karnesi</h1>
            <button class="text-primary hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-2xl">share</span>
            </button>
        </header>

        <main class="flex-1 px-6 space-y-8 overflow-y-auto no-scrollbar pb-10" id="reportContent">
            <!-- Content will be dynamically inserted here -->
            <div class="flex justify-center py-12">
                <div class="w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
            </div>
        </main>
    </div>

    <script type="module">
        import { getStudentResult } from './firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('examId');
        const resultId = urlParams.get('resultId'); // Note: Result ID might need to be tracked or found by student ID

        window.onload = async () => {
            const container = document.getElementById('reportContent');

            if (!examId || !resultId) {
                container.innerHTML = '<div class="text-center py-10 text-red-500">Sınav veya sonuç bilgisi eksik.</div>';
                return;
            }

            try {
                // Assuming firebase-config exports getStudentResult(examId, resultId)
                const resultData = await getStudentResult(examId, resultId);

                if (!resultData) {
                    container.innerHTML = '<div class="text-center py-10 text-red-500">Kayıt bulunamadı.</div>';
                    return;
                }

                // Parse answers
                let answersData = {};
                let isJsonData = false;
                try {
                    answersData = JSON.parse(resultData.rawAnswers);
                    isJsonData = true;
                } catch (e) {
                    // Fallback to simple string logic if Old format
                    answersData = { "Genel": resultData.rawAnswers };
                }

                // Generate Table Rows
                let tableHTML = '';
                let totalCorrect = 0;
                let totalWrong = 0;
                let totalNet = 0;

                const branchLabels = Object.keys(answersData);
                const chartLabels = [];
                const chartData = [];

                branchLabels.forEach(branch => {
                    const answers = answersData[branch];
                    // Simulate correct/wrong count based on answer length as placeholder
                    // In real app, this compares against answer key
                    const qCount = answers ? answers.length : 0;
                    const correct = Math.floor(qCount * (0.6 + Math.random() * 0.3)); // mock
                    const wrong = Math.floor((qCount - correct) * 0.8); // mock
                    const blank = qCount - correct - wrong;
                    const net = correct - (wrong * 0.33);

                    totalCorrect += correct;
                    totalWrong += wrong;
                    totalNet += net;

                    chartLabels.push(branch.substring(0, 3).toUpperCase());
                    chartData.push(Math.round((correct / qCount) * 100) || 0);

                    tableHTML += `
                        <tr>
                            <td class="px-5 py-4 text-xs font-black text-gray-700">${branch}</td>
                            <td class="py-4 text-xs font-bold text-green-500 text-center">${correct}</td>
                            <td class="py-4 text-xs font-bold text-red-400 text-center">${wrong}</td>
                            <td class="py-4 text-xs font-bold text-gray-300 text-center">${blank}</td>
                            <td class="px-5 py-4 text-xs font-black text-primary text-right">${net.toFixed(2)}</td>
                        </tr>
                    `;
                });

                container.innerHTML = `
                    <div class="flex items-center gap-6 pt-2">
                        <div class="relative">
                            <div class="w-24 h-24 rounded-full ring-4 ring-primary/20 p-1 bg-white">
                                <div class="w-full h-full rounded-full bg-gray-100 flex items-center justify-center text-primary font-bold text-3xl">
                                    ${resultData.name ? resultData.name.charAt(0).toUpperCase() : '?'}
                                </div>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-gray-900 leading-none mb-2">${resultData.name || 'İsimsiz'}</h2>
                            <div class="flex items-center gap-2">
                                <span class="bg-purple-100 text-primary text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-wider">
                                    ${resultData.className || 'Sınıf Yok'}
                                </span>
                                <span class="text-xs font-bold text-gray-400">No: ${resultData.studentNo || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4">SINAV ÖZETİ</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-card text-center">
                                <p class="text-[10px] font-bold text-gray-400 mb-1">Puan</p>
                                <p class="text-lg font-black text-primary mb-1">${resultData.score || '0.00'}</p>
                            </div>
                            <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-card text-center">
                                <p class="text-[10px] font-bold text-gray-400 mb-1">Toplam Net</p>
                                <p class="text-lg font-black text-gray-900 mb-1">${totalNet.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-gray-100 shadow-card overflow-hidden">
                        <div class="px-5 py-4 flex items-center justify-between border-b border-gray-50 bg-gray-50/50">
                            <h3 class="text-[13px] font-black text-gray-900 uppercase tracking-wide">Ders Bazlı Başarı</h3>
                        </div>
                        <div class="p-0">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50/30">
                                    <tr>
                                        <th class="px-5 py-3 text-[10px] font-black text-gray-400 uppercase tracking-wider">Ders Adı</th>
                                        <th class="py-3 text-[10px] font-black text-gray-400 uppercase text-center tracking-wider">D</th>
                                        <th class="py-3 text-[10px] font-black text-gray-400 uppercase text-center tracking-wider">Y</th>
                                        <th class="py-3 text-[10px] font-black text-gray-400 uppercase text-center tracking-wider">B</th>
                                        <th class="px-5 py-3 text-[10px] font-black text-primary uppercase text-right tracking-wider">Net</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                                    ${tableHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[11px] font-black text-gray-400 uppercase tracking-[0.2em] mb-4">YETERLİLİK ANALİZİ</h3>
                        <div class="bg-white rounded-3xl border border-gray-100 shadow-card p-6">
                            <div class="radar-container mb-6">
                                <canvas id="proficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                // Render Chart
                if (chartLabels.length > 0) {
                    const ctx = document.getElementById('proficiencyChart');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Başarı Oranı',
                                data: chartData,
                                fill: true,
                                backgroundColor: 'rgba(124, 58, 237, 0.2)',
                                borderColor: 'rgb(124, 58, 237)',
                                borderWidth: 3,
                                pointBackgroundColor: 'rgb(124, 58, 237)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(124, 58, 237)'
                            }]
                        },
                        options: {
                            elements: {
                                line: { tension: 0.1 }
                            },
                            scales: {
                                r: {
                                    angleLines: { display: true, color: '#f1f5f9' },
                                    grid: { color: '#f1f5f9' },
                                    suggestedMin: 0,
                                    suggestedMax: 100,
                                    ticks: { display: false },
                                    pointLabels: {
                                        font: { size: 10, weight: '700', family: 'Plus Jakarta Sans' },
                                        color: '#64748b'
                                    }
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error("Rapor yüklenemedi:", error);
                container.innerHTML = '<div class="text-center py-10 text-red-500">Rapor yüklenirken bir hata oluştu.</div>';
            }
        };
    </script>
</body>

</html>