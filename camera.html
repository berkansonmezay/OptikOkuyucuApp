<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Optik Tarama</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <meta name="color-scheme" content="light">
    <script src="theme-manager.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: "#7C3AED",
                        secondary: "#F3F4F6",
                        surface: "#FFFFFF",
                        "text-main": "#111827",
                        "text-muted": "#6B7280",
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scanner-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0;
        }

        .scanner-frame::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 4px solid #7C3AED;
            border-radius: 24px;
            opacity: 0.5;
            clip-path: polygon(0 0, 25% 0, 25% 4px, 4px 4px, 4px 25%, 0 25%, 0 0, 75% 0, 100% 0, 100% 25%, calc(100% - 4px) 25%, calc(100% - 4px) 4px, 75% 4px, 75% 0, 100% 75%, 100% 100%, 75% 100%, 75% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), calc(100% - 4px) 75%, 100% 75%, 25% 100%, 0 100%, 0 75%, 4px 75%, 4px calc(100% - 4px), 25% calc(100% - 4px), 25% 100%);
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(180deg, transparent, rgba(124, 58, 237, 0.8), transparent);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.5);
            animation: scan 3s ease-in-out infinite;
        }

        @keyframes scan {
            0% {
                top: 10%;
            }

            50% {
                top: 90%;
            }

            100% {
                top: 10%;
            }
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #111;
        }

        .capture-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background-color: #fff;
            padding: 4px;
            border: 2px solid #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .capture-btn-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #fff;
            border: 2px solid #000;
        }
    </style>
</head>

<body class="font-sans">
    <div class="max-w-md mx-auto h-full relative flex flex-col overflow-hidden">
        <!-- Top Controls -->
        <header class="absolute top-0 w-full px-6 pt-12 flex justify-between items-center z-20">
            <button onclick="window.location.href='scan-select.html'"
                class="w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="px-4 py-2 rounded-full bg-black/40 backdrop-blur-md text-[10px] font-bold tracking-[0.1em] text-white uppercase border border-white/10"
                id="examTypeLabel">
                LGS DENEME
            </div>
            <button
                class="w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white">
                <span class="material-symbols-outlined">flash_on</span>
            </button>
        </header>

        <!-- Camera Feed -->
        <video id="camera-feed" autoplay playsinline muted
            class="absolute inset-0 w-full h-full object-cover z-0"></video>
        <div id="camera-placeholder"
            class="absolute inset-0 flex items-center justify-center bg-[#111] z-0 transition-opacity duration-500">
            <span class="material-symbols-outlined text-white/20 text-[120px]">photo_camera</span>
        </div>

        <!-- Scanner Overlay -->
        <div class="scanner-overlay">
            <div class="scanner-frame">
                <div class="scan-line"></div>
                <div class="absolute -bottom-12 left-0 right-0 text-center">
                    <p class="text-xs font-medium text-white/80">Optik formu çerçeve içine hizalayın</p>
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <footer class="absolute bottom-0 w-full px-8 pb-12 flex items-center justify-between z-20">
            <button
                class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center text-white">
                <span class="material-symbols-outlined">image</span>
            </button>

            <button onclick="simulateCapture()" class="capture-btn group active:scale-95 transition-transform">
                <div class="capture-btn-inner group-hover:bg-gray-100 transition-colors"></div>
            </button>

            <div class="w-12 h-12 rounded-xl bg-primary/20 backdrop-blur-md border border-primary/30 flex items-center justify-center text-primary relative overflow-hidden group cursor-pointer"
                onclick="window.location.href='dashboard.html'">
                <span class="material-symbols-outlined z-10">check</span>
                <div
                    class="absolute inset-0 bg-primary/20 scale-0 group-hover:scale-100 transition-transform duration-500 rounded-full">
                </div>
            </div>
        </footer>

        <!-- Status Toast -->
        <div id="statusToast"
            class="absolute top-28 left-1/2 -translate-x-1/2 px-4 py-2.5 rounded-2xl bg-primary text-white text-[11px] font-bold shadow-glow flex items-center gap-2 z-30 opacity-0 transform translate-y-4 transition-all duration-300">
            <span class="material-symbols-outlined text-lg">check_circle</span>
            FORM TARANDI
        </div>
    </div>

    <script type="module">
        import { addStudentResult, getExams } from './firebase-config.js';

        let selectedExamId = null;

        let scanning = true;
        let canvasElement;
        let canvasContext;

        window.simulateCapture = async function () {
            // Keep this button but alert that it's automatic now
            alert("Kamera otomatik tarama yapmaktadır. Lütfen formu okutun.");
        }

        async function processForm(qrData) {
            if (!selectedExamId) {
                alert("Lütfen önce bir sınav seçin.");
                window.location.href = 'scan-select.html';
                return;
            }

            if (!scanning) return;
            scanning = false; // Prevent multiple scans

            const toast = document.getElementById('statusToast');
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            toast.innerHTML = '<span class="material-symbols-outlined text-lg animate-spin">sync</span> KAYDEDİLİYOR...';

            try {
                // Parse QR Data (assuming JSON or specific format)
                // Example format from the image:
                // Name: NİSA NUR YILMAZ
                // No: 70266
                // TC: 22345234958
                // Sınıf: 12

                let studentData = { name: "Bilinmeyen", studentNo: "00000", tcNo: "", class: "" };

                try {
                    // Try to parse if it's JSON
                    studentData = JSON.parse(qrData);
                } catch (e) {
                    if (qrData.includes('-')) {
                        const parts = qrData.split('-');
                        studentData.name = parts[0] ? parts[0].trim() : qrData;
                        studentData.studentNo = parts[1] ? parts[1].trim() : Math.floor(10000 + Math.random() * 90000).toString();
                        studentData.tcNo = parts[2] ? parts[2].trim() : "";
                        studentData.class = parts[3] ? parts[3].trim() : "";
                    } else {
                        studentData.name = qrData;
                        studentData.studentNo = Math.floor(10000 + Math.random() * 90000).toString();
                    }
                }

                // Mock OMR Data structure for LGS
                const mockLgsAnswers = {
                    "Türkçe": "ABACADABACADABACDDA", // 20 
                    "Sosyal Bilgiler İnkılap Tarihi ve Atatürkçülük": "ABCDABCDAB", // 10
                    "Din Kültürü ve Ahlak Bilgisi": "DDDDCCCCCB", // 10
                    "İngilizce": "AAAAABBBBB", // 10
                    "Matematik": "ABCDABCDABCDABCDABCD", // 20
                    "Fen Bilimleri": "DDDDCCCCBBBBAAAAABCD" // 20
                };

                const randomScore = (Math.random() * 500).toFixed(2);

                const resultData = {
                    name: studentData.name || studentData.AdiSoyadi || "QR İsim",
                    studentNo: studentData.studentNo || studentData.OgrenciNo || studentData.OgrenciNumarasi || "12345",
                    tcNo: studentData.tcNo || studentData.TCKimlikNo || "",
                    className: studentData.class || studentData.Sinifi || "",
                    score: randomScore,
                    booklet: Math.random() > 0.5 ? 'A' : 'B', // From OMR
                    rawAnswers: JSON.stringify(mockLgsAnswers), // Storing as JSON string
                };

                await addStudentResult(selectedExamId, resultData);

                toast.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> FORM TARANDI';

                // Get preview image data URL to pass to next screen
                // Reduce size for URL parameter (taking a smaller quality jpeg from canvas)
                const previewUrl = canvasElement ? canvasElement.toDataURL('image/jpeg', 0.5) : '';

                setTimeout(() => {
                    const encodedPreview = encodeURIComponent(previewUrl);
                    window.location.href = `scan-success.html?examId=${selectedExamId}&studentName=${encodeURIComponent(resultData.name)}&studentNo=${encodeURIComponent(resultData.studentNo)}&studentTc=${encodeURIComponent(resultData.tcNo)}&studentClass=${encodeURIComponent(resultData.className)}&previewUrl=${encodedPreview}`;
                }, 1000);

            } catch (error) {
                console.error("Error saving scan result:", error);
                toast.classList.remove('bg-primary');
                toast.classList.add('bg-red-500');
                toast.innerHTML = '<span class="material-symbols-outlined text-lg">error</span> HATA OLUŞTU';
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-4');
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('bg-primary');
                    toast.classList.remove('bg-red-500');
                    scanning = true; // allow scan again
                }, 2000);
            }
        }

        window.onload = async () => {
            // Get selected exam from URL params
            const urlParams = new URLSearchParams(window.location.search);
            selectedExamId = urlParams.get('examId');

            if (!selectedExamId) {
                // Determine the most recent exam if none selected (for testing)
                const exams = await getExams();
                if (exams && exams.length > 0) {
                    selectedExamId = exams[0].id;
                    document.getElementById('examTypeLabel').textContent = exams[0].name || "SINAV";
                } else {
                    document.getElementById('examTypeLabel').textContent = "SINAV SEÇİLMEDİ";
                }
            } else {
                document.getElementById('examTypeLabel').textContent = "Taranıyor...";
                // Ideally fetch exam name by ID and display it here
                const exams = await getExams();
                const exam = exams.find(e => e.id === selectedExamId);
                if (exam) {
                    document.getElementById('examTypeLabel').textContent = exam.name || "SINAV";
                }
            }

            // Create hidden canvas for jsQR
            canvasElement = document.createElement("canvas");
            canvasContext = canvasElement.getContext("2d", { willReadFrequently: true });

            // Initialize Camera
            await initCamera();
        };

        function tick() {
            const videoEl = document.getElementById('camera-feed');
            if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA && scanning) {
                canvasElement.height = videoEl.videoHeight;
                canvasElement.width = videoEl.videoWidth;
                canvasContext.drawImage(videoEl, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);

                // jsQR scanning
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    console.log("Found QR code", code.data);
                    // Draw box around QR (optional, skipped for brevity)
                    processForm(code.data);
                } else {
                    // Keep scanning
                    requestAnimationFrame(tick);
                }
            } else {
                requestAnimationFrame(tick);
            }
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                const videoEl = document.getElementById('camera-feed');
                videoEl.srcObject = stream;

                // Hide placeholder once video playing
                videoEl.onplaying = () => {
                    document.getElementById('camera-placeholder').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('camera-placeholder').style.display = 'none';
                        requestAnimationFrame(tick); // start scanning loop
                    }, 500);
                };
            } catch (err) {
                console.error("Camera access error:", err);
                const placeholder = document.getElementById('camera-placeholder');
                placeholder.innerHTML = `<div class="text-center text-red-400 p-4"><span class="material-symbols-outlined text-[64px] mb-2">no_photography</span><br/>Kamera erişimi reddedildi veya bulunamadı. Lütfen izin verin.</div>`;
            }
        }
    </script>
</body>

</html>